---
title: "NP Draft 6"
author: "Joanna Tang"
date: "4/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r include = FALSE}

# Loading packages, read in data  
library(pairwiseAdonis)
library(kableExtra)
library(vegan)
library(car)
library(RColorBrewer)
library(reshape2)
library(kableExtra)
library(FSA)
library(plotly)
library(ggsignif)
library(lme4)
library(bestNormalize)
library(betareg)
library(nlme)
library(MASS)
library(fitdistrplus)
library(plotrix)
library(janitor)
library(ggpubr)
library(rstatix)
library(NbClust)
library(tidyverse)

np_percent_cover_master <- read_csv("np_percent_cover.csv")
metadata <- read_csv("metadata.csv")
np_2016_seedbank_master <- read_csv("np_2016_seedbank.csv")
np_2018_seed_bank_master <- read_csv("np.2018.seed.bank.csv")
del_sol_seedbank_master <- read_csv("del_sol_seedbank.csv")
biomass_master <- read_csv("combined_biomass.csv")
del_sol_master <- read_csv("delsol.csv")
noaa <- read_csv("1567450.csv")
np_pc_ord <- read_csv("pc-ord_nms_scores.csv")
np_community_matrix_variables <- read_csv("np_community_matrix_variables.csv")

```


```{r include = FALSE}

# Outline

# 0. Tidy up data

# 1. How does exotic community change over time?
## 1a. How does total exotic percent cover change with time since restoration (and interannual climate variability?)? (boxplots)
## 1b. Is there a threshold (# of years) after which exotic abundance increases? (linear model)
## 1c. Do pools converge on the same exotic community composition over time? (NMDS)

# 2. What environmental filters can be manipulated to decrease exotics?
## 2a. How does the seedbank compare to the aboveground cover? (presence/absence data)
## 2b. Does active management result in a different exotic community? (NMDS w/ old Del Sol data)
## 2c. Do certain exotics and natives occupy the same (phenological) niche? (NMDS, or scatterplot b/t 2 species)

# 3. What is the ideal monitoring plan?
## 3a. Same as 1b -- is there a threshold after which exotics increase (i.e., what's the ideal duration of monitoring?)?
## 3b. What is the ideal frequency/season of monitoring? (boxplots)


```


```{r include = FALSE}

# 0. Tidy up data

## Separate "Replicate" label into Replicate_Zone and Replicate_Number, join with species metadata, convert month and year to "date" column
np_percent_cover <- np_percent_cover_master %>% 
  mutate(Replicate_Zone = case_when(Replicate == "C1" ~ "C", Replicate == "C2" ~ "C", Replicate == "C3" ~ "C", Replicate == "T1" ~ "T", Replicate == "T2" ~ "T", Replicate == "T3" ~ "T", Replicate == "U1" ~ "U", Replicate == "U2" ~ "U", Replicate == "U3" ~ "U")) %>% 
  mutate(Replicate_Number = case_when(Replicate == "C1" ~ "1", Replicate == "C2" ~ "2", Replicate == "C3" ~ "3", Replicate == "T1" ~ "1", Replicate == "T2" ~ "2", Replicate == "T3" ~ "3", Replicate == "U1" ~ "1", Replicate == "U2" ~ "2", Replicate == "U3" ~ "3"))
np_percent_cover <- full_join(np_percent_cover, metadata) %>% 
  mutate(month_number = case_when(Month == "JANUARY" ~ 1, Month == "FEBRUARY" ~ 2, Month == "MARCH" ~ 3, Month == "APRIL" ~ 4, Month == "MAY" ~ 5, Month == "JUNE" ~ 6, Month == "JULY" ~ 7, Month == "AUGUST" ~ 8, Month == "SEPTEMBER" ~ 9, Month == "OCTOBER" ~ 10, Month == "NOVEMBER" ~ 11, Month == "DECEMBER" ~ 12)) %>% 
  mutate(date = paste(Year, month_number, "1", sep="-" )) %>% 
  dplyr::select(-X8)
np_percent_cover$date = as.Date(np_percent_cover$date)


## Convert np_2016_seedbank into tidy format, remove NAs, separate "Replicate" label into Replicate_Zone and Replicate_Number, add Year column, add seedbank column, join to metadata
seedbank_2016 <- gather(np_2016_seedbank_master, key = "Species", value = "Count", -c(Plot, Replicate)) %>% 
  na.omit(np_2016_seedbank_master) %>% 
  mutate(Replicate_Zone = case_when(Replicate == "C1" ~ "C", Replicate == "C2" ~ "C", Replicate == "C3" ~ "C", Replicate == "T1" ~ "T", Replicate == "T2" ~ "T", Replicate == "T3" ~ "T", Replicate == "U1" ~ "U", Replicate == "U2" ~ "U", Replicate == "U3" ~ "U")) %>% 
  mutate(Replicate_Number = case_when(Replicate == "C1" ~ "1", Replicate == "C2" ~ "2", Replicate == "C3" ~ "3", Replicate == "T1" ~ "1", Replicate == "T2" ~ "2", Replicate == "T3" ~ "3", Replicate == "U1" ~ "1", Replicate == "U2" ~ "2", Replicate == "U3" ~ "3")) %>% 
  filter(Count>0) %>%
  add_column(Year = 2016) %>% 
  add_column(seedbank = "seedbank_2016") %>% 
  full_join(metadata)

## Calculate total abundance of each species per Replicate for North Parcel 2018 seed bank data, separate "Replicate" label into Replicate_Zone and Replicate_Number, add Year column, add seedbank column, join to metadata
np_seedbank_2018 <- np_2018_seed_bank_master %>% 
  group_by(Plot, Replicate, Species) %>% 
  summarize(Count = sum(Count)) %>% 
  mutate(Replicate_Zone = case_when(Replicate == "C1" ~ "C", Replicate == "C2" ~ "C", Replicate == "C3" ~ "C", Replicate == "T1" ~ "T", Replicate == "T2" ~ "T", Replicate == "T3" ~ "T", Replicate == "U1" ~ "U", Replicate == "U2" ~ "U", Replicate == "U3" ~ "U")) %>% 
  mutate(Replicate_Number = case_when(Replicate == "C1" ~ "1", Replicate == "C2" ~ "2", Replicate == "C3" ~ "3", Replicate == "T1" ~ "1", Replicate == "T2" ~ "2", Replicate == "T3" ~ "3", Replicate == "U1" ~ "1", Replicate == "U2" ~ "2", Replicate == "U3" ~ "3")) %>% 
  add_column(Year = 2018) %>% 
  add_column(seedbank = "seedbank_2018") %>% 
  full_join(metadata)

## Calculate total abundance of each species per Replicate for Del Sol 2018 seed bank data, separate "Replicate" label into Replicate_Zone and Replicate_Number, add Year column, add seedbank column, join to metadata
del_sol_seedbank <- del_sol_seedbank_master %>% 
  group_by(Plot, Replicate, Species) %>% 
  summarize(Count = sum(Count)) %>% 
  mutate(Replicate_Zone = case_when(Replicate == "C1" ~ "C", Replicate == "C2" ~ "C", Replicate == "C3" ~ "C", Replicate == "T1" ~ "T", Replicate == "T2" ~ "T", Replicate == "T3" ~ "T", Replicate == "U1" ~ "U", Replicate == "U2" ~ "U", Replicate == "U3" ~ "U")) %>% 
  mutate(Replicate_Number = case_when(Replicate == "C1" ~ "1", Replicate == "C2" ~ "2", Replicate == "C3" ~ "3", Replicate == "T1" ~ "1", Replicate == "T2" ~ "2", Replicate == "T3" ~ "3", Replicate == "U1" ~ "1", Replicate == "U2" ~ "2", Replicate == "U3" ~ "3")) %>% 
  add_column(Year = 2018) %>% 
  add_column(seedbank = "del_sol_seedbank_2018") %>% 
  full_join(metadata)

## Join Del Sol % cover data to metadata
del_sol <- full_join(del_sol_master, metadata)


```

# 1. Is sustained weeding effort a successful long-term restoration strategy?

## 1a. How does total exotic percent cover change with time since restoration?

Hypothesis: If sustained weeding (routine weed-whacking, monthly hand-weeding) is successful, total exotic cover will remain low.

Results: Significant increase in total exotic percent cover after year 4 -- due to increase in exotics in transition and upland zones.


```{r echo = FALSE, message = FALSE, warning = FALSE}

# 1a. How does total exotic abundance change with time since restoration (and interannual climate variability?)? (boxplots)


## Create new data frame with creation year of each pool
creation_year_df <- data.frame(Plot = c("PH1", "TP", "RT", "MS", "WT1", "WT2", "CS"), Creation_Year = c("2010", "2012", "2012", "2015", "2014", "2014", "2013"))

## Calculate total exotic % cover per quadrat, find max total exotic % cover per quadrat per year, add time since restoration column
np_annual_total_exotic <- np_percent_cover %>%
  filter(Native_Status == "E") %>% 
  filter(Year > 2016) %>% 
  group_by(date, Year, Month, Plot, Replicate, Replicate_Zone) %>% 
  summarize(total_exotic_pc = sum(percent_cover)) %>% 
  drop_na() %>% 
  group_by(Year, Plot, Replicate, Replicate_Zone) %>% 
  summarize(max_annual_exotic_pc = max(total_exotic_pc)) %>% 
  full_join(creation_year_df) %>% 
  mutate(Creation_Year = as.numeric(as.character(Creation_Year))) %>% 
  mutate(Time_Since = Year - Creation_Year)

### Check for normality
exotic_pc_hist <- ggplot(np_annual_total_exotic, aes(x = max_annual_exotic_pc)) +
  geom_histogram()
#not normal -- skewed right
exotic_pc_qq <- ggplot(np_annual_total_exotic, aes(sample = max_annual_exotic_pc)) +
  geom_qq()
#not normal -- skewed right




## Dataframe of biomass with metadata
max_exotic_biomass <- biomass_master %>% 
  filter(Year>2016) %>% 
  filter(Year<2020) %>% 
  full_join(creation_year_df) %>% 
  mutate(Creation_Year = as.numeric(as.character(Creation_Year))) %>% 
  mutate(Time_Since = Year - Creation_Year) %>% 
  drop_na(Time_Since) %>% 
  mutate(Replicate_Zone = case_when(Replicate == "C1" ~ "C", Replicate == "C2" ~ "C", Replicate == "C3" ~ "C", Replicate == "T1" ~ "T", Replicate == "T2" ~ "T", Replicate == "T3" ~ "T", Replicate == "U1" ~ "U", Replicate == "U2" ~ "U", Replicate == "U3" ~ "U")) %>% 
  drop_na(Replicate_Zone) %>% 
  group_by(Year, Plot, Replicate_Zone, Replicate, Creation_Year, Time_Since) %>% 
  summarize(max = max(biomass_g))

### Check for normality
exotic_biomass_hist <- ggplot(max_exotic_biomass, aes(x = max)) +
  geom_histogram()
#not normal -- skewed right
exotic_biomass_qq <- ggplot(max_exotic_biomass, aes(sample = max)) +
  geom_qq()
#not normal -- skewed right





## Boxplot of total exotic % cover, by time since
exotic_pc_time_box <- np_annual_total_exotic %>% 
  ggplot(aes(x = as.factor(Time_Since), y = max_annual_exotic_pc)) +
  geom_boxplot(fill = "coral3") +
  geom_jitter(width = .2, alpha = .4) +
  labs(title = "Total Percent Cover of Exotics, over time", x = "Time Since Restoration (years)", y = "Percent Cover (%)", caption = "Increase in median after year 4 \n driven by sig increase in transition and upland zones (Kruskal-Wallis p << 0.001)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 100))
exotic_pc_time_box

### Kruskal-Wallis for exotic % cover, by time since
exotic_pc_time_kw <- kruskal.test(max_annual_exotic_pc ~ as.factor(Time_Since), data = np_annual_total_exotic)
#p << .001
### Post-hoc Dunn's test
exotic_pc_time_dunn <- dunnTest(max_annual_exotic_pc ~ as.factor(Time_Since), data = np_annual_total_exotic)
#3-5 p = .00545, 4-5 p = .0726, 2-6 p = .0594, 3-7 p = .000131, 4-7 p = .00242, 3-8 p = .00685, 4-8 p = .0523, 3-9 p = .0144, 4-9 p = .0794


## Boxplot of exotic biomass, by time since
exotic_biomass_time_box <- max_exotic_biomass %>% 
  ggplot(aes(x = as.factor(Time_Since), y = max)) +
  geom_boxplot(fill = "coral3") +
  geom_jitter(width = .2, alpha = .4) +
  labs(title = "Total Biomass of Exotics, over time", x = "Time Since Restoration (years)", y = "Biomass (g)", caption = "Increase in median around year 5 \n driven by sig increase in transition and upland zones (Kruskal-Wallis p << 0.001)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 100))
exotic_biomass_time_box

### Kruskal-Wallis for exotic biomass, by time since
exotic_biomass_time_kw <- kruskal.test(max ~ as.factor(Time_Since), data = max_exotic_biomass)
#p << .001
### Post-hoc Dunn's test
exotic_biomass_time_dunn <- dunnTest(max ~ as.factor(Time_Since), data = max_exotic_biomass)
#3-5 p = .0342, 3-6 p = .0544, 4-7 p << .001, 3-7 p << .001, 4-7 p = .0363, 3-8 p = .0727, 3-9 p << .001, 4-9 p = .0650





## Boxplot of total exotic % cover, by time since, per zone
exotic_pc_time_zone_box <- np_annual_total_exotic %>% 
  ggplot(aes(x = as.factor(Time_Since), y = max_annual_exotic_pc)) +
  geom_boxplot(fill = "coral3") +
  geom_jitter(width = .2, alpha = .4) +
  facet_wrap(~Replicate_Zone) +
  labs(title = "Total Percent Cover of Exotics, over time, per zone", x = "Time Since Restoration (years)", y = "Percent Cover (%)", caption = "Increase in median \n driven by sig increase in transition and upland zones (Kruskal-Wallis p << 0.001)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 100))
exotic_pc_time_zone_box

### Kruskal-Wallis for exotic % cover, by time since, for central zone
exotic_pc_time_c_kw <- np_annual_total_exotic %>% 
  filter(Replicate_Zone == "C") %>% 
  kruskal.test(max_annual_exotic_pc ~ as.factor(Time_Since))
#p << .001
### Post-hoc Dunn's test
exotic_pc_time_c_dunn <- np_annual_total_exotic %>% 
  filter(Replicate_Zone == "C")
exotic_pc_time_c_dunn <- dunnTest(max_annual_exotic_pc ~ as.factor(Time_Since), data = exotic_pc_time_c_dunn)
#2-3 p.unadj = .0747, 2-4 p.unadj = .0483, 2-6 p.unadj = .0846, 3-8 p.unadj = .0349, 4-8 p.unadj = .0196, 5-8 p.unadj = .0614, 6-8 p.unadj = .0381
### Kruskal-Wallis for exotic % cover, by time since, for transition zone
exotic_pc_time_t_kw <- np_annual_total_exotic %>% 
  filter(Replicate_Zone == "T") %>% 
  kruskal.test(max_annual_exotic_pc ~ as.factor(Time_Since))
#p << .001
### Post-hoc Dunn's test
exotic_pc_time_t_dunn <- np_annual_total_exotic %>% 
  filter(Replicate_Zone == "T")
exotic_pc_time_t_dunn <- dunnTest(max_annual_exotic_pc ~ as.factor(Time_Since), data = exotic_pc_time_t_dunn)
#3-5 p = .0545, 3-7 p = .00647, 3-8 p = .0940
### Kruskal-Wallis for exotic % cover, by time since, for upland zone
exotic_pc_time_u_kw <- np_annual_total_exotic %>% 
  filter(Replicate_Zone == "U") %>% 
  kruskal.test(max_annual_exotic_pc ~ as.factor(Time_Since))
#p << .001
### Post-hoc Dunn's test
exotic_pc_time_u_dunn <- np_annual_total_exotic %>% 
  filter(Replicate_Zone == "U")
exotic_pc_time_u_dunn <- dunnTest(max_annual_exotic_pc ~ as.factor(Time_Since), data = exotic_pc_time_u_dunn)
#2-7 p = .0685, 3-7 p = .00188, 4-7 p = .0154, 2-9 p = .0716, 3-9 p = .0148, 4-9 p = .0663


## Boxplot of exotic biomass, by time since, per zone
exotic_biomass_time_zone_box <- max_exotic_biomass %>% 
  ggplot(aes(x = as.factor(Time_Since), y = max)) +
  geom_boxplot(fill = "coral3") +
  geom_jitter(width = .2, alpha = .4) +
  facet_wrap(~Replicate_Zone) +
  labs(title = "Total Biomass of Exotics, over time", x = "Time Since Restoration (years)", y = "Biomass (g)", caption = "Increase in median after year 5 \n driven by sig increase in transition and upland zones (Kruskal-Wallis p << 0.00)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 100))
exotic_biomass_time_zone_box

### Kruskal-Wallis for exotic biomass, by time since, for central zone
exotic_biomass_time_c_kw <- max_exotic_biomass %>% 
  filter(Replicate_Zone == "C") %>% 
  kruskal.test(max ~ as.factor(Time_Since), data = .)
#p = .4131
### Kruskal-Wallis for exotic biomass, by time since, for transition zone
exotic_biomass_time_t_kw <- max_exotic_biomass %>% 
  filter(Replicate_Zone == "T") %>% 
  kruskal.test(max ~ as.factor(Time_Since), data = .)
#p = .0006191
### Post-hoc Dunn's test
exotic_biomass_time_t_dunn <- max_exotic_biomass %>% 
  filter(Replicate_Zone == "T") %>% 
  dunnTest(max ~ as.factor(Time_Since), data = .)
#3-7 p = .00174, 3-9 p = .0511
### Kruskal-Wallis for exotic biomass, by time since, for upland zone
exotic_biomass_time_u_kw <- max_exotic_biomass %>% 
  filter(Replicate_Zone == "U") %>% 
  kruskal.test(max ~ as.factor(Time_Since), data = .)
#p << .001
### Post-hoc Dunn's test
exotic_biomass_time_u_dunn <- max_exotic_biomass %>% 
  filter(Replicate_Zone == "U") %>% 
  dunnTest(max ~ as.factor(Time_Since), data = .)
#2-7 p = .0947, 3-7 p = .00103, 4-7 p = .0125, 3-9 p = .0148, 4-9 p = .0829




## Boxplot of total exotic % cover, by monitoring year
exotic_pc_year_box <- np_annual_total_exotic %>% 
  ggplot(aes(x = as.factor(Year), y = max_annual_exotic_pc)) +
  geom_boxplot(fill = "coral3") +
  geom_jitter(width = .2, alpha = .4) +
  labs(title = "Total Percent Cover of Exotics, by monitoring year", x = "Year", y = "Percent Cover (%)", caption = "Sig increase in median in 2019 (Kruskal-Wallis p = 0.021) \n (but difference between monitoring years is less than difference across time since restoration)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 100))
exotic_pc_year_box

### Kruskal-Wallis for exotic % cover, by monitoring year
exotic_pc_year_kw <- kruskal.test(max_annual_exotic_pc ~ as.factor(Year), data = np_annual_total_exotic)
#p = .02106
### Post-hoc Dunn's test
exotic_pc_year_dunn <- dunnTest(max_annual_exotic_pc ~ as.factor(Year), data = np_annual_total_exotic)
#2017-2019 p = .0339, 2018-2019 p = .0487


## Boxplot of exotic biomass, by monitoring year
exotic_biomass_year_box <- max_exotic_biomass %>% 
  ggplot(aes(x = as.factor(Year), y = max)) +
  geom_boxplot(fill = "coral3") +
  geom_jitter(width = .2, alpha = .4) +
  labs(title = "Total Biomass of Exotics, by monitoring year", x = "Year", y = "Biomass (g)", caption = "2019 median sig higher (Dunn's Kruskal-Wallis Multiple Comparisons p << 0.001)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 100))
exotic_biomass_year_box

### Kruskal-Wallis for exotic biomass, by time since
exotic_biomass_year_kw <- kruskal.test(max ~ as.factor(Year), data = max_exotic_biomass)
#p << .001
### Post-hoc Dunn's test
exotic_biomass_year_dunn <- dunnTest(max ~ as.factor(Year), data = max_exotic_biomass)
#2017-2019 p << .001, 2018-2019 p << .001


## Boxplot of total exotic % cover, by zone
exotic_pc_zone_box <- np_annual_total_exotic %>% 
  ggplot(aes(x = as.factor(Replicate_Zone), y = max_annual_exotic_pc)) +
  geom_boxplot(fill = "coral3") +
  geom_jitter(width = .2, alpha = .4) +
  labs(title = "Total Percent Cover of Exotics, by zone", x = "Zone", y = "Percent Cover (%)", caption = "Sig difference in median between zones (Kruskal-Wallis p << 0.001)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 100))
exotic_pc_zone_box

### Kruskal-Wallis for exotic % cover, by zone
exotic_pc_zone_kw <- kruskal.test(max_annual_exotic_pc ~ as.factor(Replicate_Zone), data = np_annual_total_exotic)
#p << .001
### Post-hoc Dunn's test
exotic_pc_zone_dunn <- dunnTest(max_annual_exotic_pc ~ as.factor(Replicate_Zone), data = np_annual_total_exotic)
#all p << .001


## Boxplot of exotic biomass, by zone
exotic_biomass_zone_box <- max_exotic_biomass %>% 
  ggplot(aes(x = as.factor(Replicate_Zone), y = max)) +
  geom_boxplot(fill = "coral3") +
  geom_jitter(width = .2, alpha = .4) +
  labs(title = "Total Biomass of Exotics, over time", x = "Zone", y = "Biomass (g)", caption = "Central zone has sig lower median than transition zone (Dunn's Kruskal-Wallis Multiple Comparisons p << 0.001) \n and upland zone (Dunn's Kruskal-Wallis Multiple Comparisons p << 0.001)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 100))
exotic_biomass_zone_box

### Kruskal-Wallis for exotic biomass, by zone
exotic_biomass_zone_kw <- kruskal.test(max ~ as.factor(Replicate_Zone), data = max_exotic_biomass)
#p << .001
### Post-hoc Dunn's test
exotic_biomass_zone_dunn <- dunnTest(max ~ as.factor(Replicate_Zone), data = max_exotic_biomass)
#C-T p << .001, C-U p << .001, T-U p = .0751


```

## 1b. How does exotic diversity change with time since restoration?

Hypothesis: If sustained weeding (routine weed-whacking, monthly hand-weeding) is successful, exotic diversity will remain low.

Results: No significant change in Shannon's Index of exotic community.

```{r echo = FALSE, message = FALSE, warning = FALSE}

#1b. How does exotic diversity change with time since restoration?

## Shannon's Index for exotic community of each plot
exotic_h_df <- np_percent_cover %>% 
  filter(Replicate_Zone != "NA") %>% 
  filter(Native_Status == "E") %>% 
  mutate(Replicate_Zone = case_when(Replicate_Zone == "C" ~ "1", Replicate_Zone == "T" ~ "2", Replicate_Zone == "U" ~ "3")) %>% 
  mutate(Plot = case_when(Plot == "PH1" ~ "1", Plot == "TP" ~ "7", Plot == "RT" ~ "4", Plot == "MS" ~ "9", Plot == "WT1" ~ "14", Plot == "WT2" ~ "16", Plot == "CS" ~"19")) %>% 
  group_by(date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(mean_pc = mean(percent_cover)) %>% 
  mutate(replicate_date = paste(Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  pivot_wider(names_from = Species, values_from = mean_pc) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  column_to_rownames("replicate_date") %>% 
  select(7:70) %>% 
  diversity() %>% 
  as.data.frame() %>% 
  rownames_to_column("replicate_date") %>%
  rename("h" = ".") %>% 
  inner_join(np_community_matrix_variables)

## Exploratory graphs
exotic_h_hist <- exotic_h_df %>% 
  ggplot(aes(x = h)) +
  geom_histogram()
#not normal -- skewed right
exotic_shannon_qq <- exotic_h_df %>% 
  ggplot(aes(sample = h)) +
  geom_qq()
#not normal -- skewed right

### Kruskal-Wallis for exotic H', by monitoring year
exotic_h_year_kw <- kruskal.test(h ~ as.factor(Year), data = exotic_h_df)
#p = .4126



## Boxplot for exotic H', by age
exotic_h_age_box <- exotic_h_df %>% 
  ggplot(aes(x = as.factor(age), y = h)) +
  geom_boxplot(fill = "coral3") +
  geom_jitter(width = .2, alpha = .4) +
  labs(title = "Exotic Species Diversity, by plot", x = "Time Since Restoration (years)", y = "Shannon's Index", caption = "No sig difference in Shannon's Index across years (Kruskal-Wallis p = 0.23) \n (regardless of zone as well)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0))
exotic_h_age_box

### Kruskal-Wallis for exotic H', by age
exotic_h_age_kw <- kruskal.test(h ~ as.factor(age), data = exotic_h_df)
#p = .2342



## Boxplot for exotic community, by monitoring month
exotic_h_month_box <- exotic_h_df %>% 
  ggplot(aes(x = as.factor(month), y = h)) +
  geom_boxplot(fill = "coral3") +
  geom_jitter(width = .2, alpha = .4) +
  labs(title = "Exotic Species Diversity, by montoring month", x = "Month", y = "Shannon's Index", caption = "Sig difference in exotic community between monitoring months (Kruskall-Wallis p << 0.001)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0))
#exotic_h_month_box

### Kruskal-Wallis for exotic H', by monitoring month
exotic_h_month_kw <- kruskal.test(h ~ as.factor(month), data = exotic_h_df)
#p << .001
### Post-hoc Dunn's test
exotic_h_month_dunn <- dunnTest(h ~ as.factor(month), data = exotic_h_df)
#April-Aug p = .005, Aug-Feb p = .00572, April-July p = .002298, Feb-July p = .00197, Aug-March p = .00194, July-March p = .0002998




## Boxplot for exotic H', by zone
exotic_h_zone_box <- exotic_h_df %>% 
  ggplot(aes(x = as.factor(Replicate_Zone), y = h)) +
  geom_boxplot(fill = "coral3") +
  geom_jitter(width = .2, alpha = .4) +
  labs(title = "Exotic Species Diversity, by zone", x = "Zone", y = "Shannon's Index", caption = "Sig difference in exotic community between zones (Kruskal-Wallis p << 0.001)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0))
exotic_h_zone_box

### Kruskal-Wallis for exotic H', by zone
exotic_h_zone_kw <- kruskal.test(h ~ as.factor(Replicate_Zone), data = exotic_h_df)
#p << .001
### Post-hoc Dunn's test
exotic_h_month_dunn <- dunnTest(h ~ as.factor(Replicate_Zone), data = exotic_h_df)
#all p << .001


```


## 1c. Is there a threshold (# of years) after which exotic abundance increases?

Hypothesis: We will see increased exotic species percent cover and diversity with increased time since restoration due to reinvasion.

```{r echo = FALSE, message = FALSE, warning = FALSE}

# 1c. Is there a threshold (# of years) after which exotic abundance increases? (linear model)

## Dataframe of median of the max annual total % cover of each pool
np_annual_total_exotic_medians <- np_annual_total_exotic %>% 
  group_by(Year, Plot, Time_Since) %>% 
  summarize(median = median(max_annual_exotic_pc))

# Scatterplot of median of annual max total % exotic cover
np_annual_total_exotic_medians_scatter <- np_annual_total_exotic_medians %>% 
  ggplot(aes(x = Time_Since, y = median, group = Plot)) +
  geom_point(aes(color = Plot)) +
  geom_smooth(method = lm, aes(x = Time_Since, group = NULL), se = TRUE, size = .5) +
  labs(title = "Total Percent Cover of Exotics", x = "Time Since Restoration (years)", y = "Median Percent Cover (%)", caption = "High variation; WT2, PH1, & esp WT1 and RT increased") +
  theme_classic() +
  scale_color_brewer(palette = "Dark2", name = "Vernal Pool") +
  scale_y_continuous(expand = c(0,0))
np_annual_total_exotic_medians_scatter

```



## 1d. Do pools converge on the same exotic community composition over time?

Hypothesis: Pools that are restored in the same way will converge on the same exotic community over time.

Results: Sig difference in exotic community across age (perMANOVA p = 0.001) -- community changes at year 4

```{r include = FALSE}

# 1d. Do pools converge on the same exotic community composition over time?

## Exploratory graphs using vegan

## Community matrix
np_community_matrix <- np_percent_cover %>% 
  filter(Replicate_Zone != "NA") %>% 
  mutate(Replicate_Zone = case_when(Replicate_Zone == "C" ~ "1", Replicate_Zone == "T" ~ "2", Replicate_Zone == "U" ~ "3")) %>% 
  mutate(Plot = case_when(Plot == "PH1" ~ "1", Plot == "TP" ~ "7", Plot == "RT" ~ "4", Plot == "MS" ~ "9", Plot == "WT1" ~ "14", Plot == "WT2" ~ "16", Plot == "CS" ~"19")) %>% 
  group_by(date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(mean_pc = mean(percent_cover)) %>% 
  mutate(replicate_date = paste(Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  pivot_wider(names_from = Species, values_from = mean_pc) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  column_to_rownames("replicate_date") %>% 
  select(7:141)



## How speciose are my communities?
np_richness <- specnumber(np_community_matrix)

### Does species richness differ b/t pools?
np_richness_aov <- aov(np_richness ~ Plot, data = np_community_matrix_variables)
#summary(np_richness_aov)
#p = .779, F = .078
#no sig difference of richness b/t pools

#### Richness, by plot
np_richness_box <- np_richness %>% 
  enframe() %>% 
  full_join(np_community_matrix_variables, by = c("name" = "replicate_date")) %>% 
  ggplot(aes(x = as.factor(Plot), y = value)) +
  geom_boxplot() +
  geom_jitter(width = .2, alpha = .4) +
  labs(title = "Species Richness, by plot", x = "Pool", y = "Richness", caption = "No difference in species richness across plots (ANOVA p = 0.779, F = 0.078))") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0))
#np_richness_box




## How diverse are my communities?
np_shannon <- diversity(np_community_matrix)

### Does diversity differ b/t pools?
np_shannon_aov <- aov(np_shannon ~ Plot, data = np_community_matrix_variables)
#summary(np_shannon_aov)
#p = .082, F = .775
#no sig difference of diversity b/t pools

#### Shannon's Diversity, by plot
np_shannon_box <- np_shannon %>% 
  enframe() %>% 
  full_join(np_community_matrix_variables, by = c("name" = "replicate_date")) %>% 
  ggplot(aes(x = as.factor(Plot), y = value)) +
  geom_boxplot() +
  geom_jitter(width = .2, alpha = .4) +
  labs(title = "Species Diversity, by plot", x = "Pool", y = "Shannon's Index", caption = "No difference in Shannon's Diversity across plots (ANOVA p = 0.082, F = 0.775))") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0))
#np_shannon_box






## How different are my communities in species composition? (perMANOVA)
np_permanova <- adonis(np_community_matrix ~ Plot, data = np_community_matrix_variables)
#p = .051, F = 2.1151

### NMDS
np_nmds <- metaMDS(np_community_matrix)
#stressplot(np_nmds)
#Generally, an average stress of > 0.2 is an indication that the ordination didn’t do a good job of representing community structure. However, NMDS stress increases as sample size increases, so if you have many samples (as this dataset does) your ordination will likely exhibit a lot of stress

np_nmds_scores <- scores(np_nmds, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("replicate_date") %>% 
  full_join(np_community_matrix_variables)

np_nmds_fit <- envfit(np_nmds, np_community_matrix, perm = 999) #envfit() takes the output of metaMDS() and the species matrix you created

np_nmds_fit_pvals <- np_nmds_fit$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".") #extract p-values for each species

np_nmds_fit_coords <- np_nmds_fit %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., np_nmds_fit_pvals, by = "species") %>% 
  filter(pvals == 0.001) #extract coordinates for species, only keep species with p-val = 0.001

### NMDS, by plot
np_nmds_plot <- ggplot(np_nmds_scores, aes(x = NMDS1, y = NMDS2, color = as.factor(Plot), shape = as.factor(Plot))) +
  geom_point() +
  stat_ellipse(linetype = 2, size = 1) +
  theme_classic() +
  labs(title = "NMDS, by plot", caption = "No difference in community across plots (perANOVA p = 0.051, F = 2.11))")
#np_nmds_plot






## How is community structure related to specific environmental variables? (CCA)

np_cca <- cca(np_community_matrix ~ creation_year + do_mg + depth_in + salinity + area_m2 + month, data = np_community_matrix_variables)
np_cca_baseplot <- plot(np_cca)
#get the scaling right for the vectors (blue in the base plot). To do this, you can store the base plot in an object, run that object, and extract the attr(,"arrow.mul") value from the summary that pops up in the console.
#attr(,"arrow.mul") = 27.11853

np_cca_vectors <- as.matrix(scores(np_cca, display = "bp", scaling = "species")*27.11853
) %>% 
  as.data.frame() #extract vectors

np_cca_site_coords <- scores(np_cca, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("replicate_date") %>% 
  full_join(np_community_matrix_variables) #extract site coordinates

np_cca_species_coords <- scores(np_cca, display = "species") %>% 
  as.data.frame() #extract species coordinates

#### CCA, with environmental biplot
np_cca_biplot <- ggplot(np_cca_site_coords) +
  geom_point(aes(x = CCA1, y = CCA2, color = as.factor(Plot)), shape = 19, size = 2, alpha = 0.8) +
  coord_fixed() +
  geom_segment(data = np_cca_vectors, aes(x = 0, y = 0, xend = CCA1, yend = CCA2), arrow = arrow(length = unit(0.2, "cm"))) +
  geom_vline(xintercept = c(0), color = "grey70", linetype = 2) +
  geom_hline(yintercept = c(0), color = "grey70", linetype = 2) +
  geom_point(data = np_cca_species_coords, aes(x = CCA1, y = CCA2), shape = 17, size = 2, color = "slateblue") +
  scale_x_continuous(limits = c(-12, 10)) +
  scale_y_continuous(limits = c(-3, 12)) +
  geom_text(data = np_cca_vectors, aes(x = CCA1, y = CCA2, label = rownames(np_cca_vectors)), nudge_x = 0.3, nudge_y = 0.3) +
  labs(title = "Canonical Correspondence Analysis")
np_cca_biplot

```



```{r echo = FALSE, message = FALSE, warning = FALSE}
# 1d. Do pools converge on the same exotic community composition over time? (NMDS)

## Exotic community matrix
exotic_community_matrix <- np_percent_cover %>% 
  filter(Replicate_Zone != "NA") %>% 
  filter(Native_Status == "E") %>% 
  mutate(Replicate_Zone = case_when(Replicate_Zone == "C" ~ "1", Replicate_Zone == "T" ~ "2", Replicate_Zone == "U" ~ "3")) %>% 
  mutate(Plot = case_when(Plot == "PH1" ~ "1", Plot == "TP" ~ "7", Plot == "RT" ~ "4", Plot == "MS" ~ "9", Plot == "WT1" ~ "14", Plot == "WT2" ~ "16", Plot == "CS" ~"19")) %>% 
  group_by(date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(mean_pc = mean(percent_cover)) %>% 
  mutate(replicate_date = paste(Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  pivot_wider(names_from = Species, values_from = mean_pc) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  column_to_rownames("replicate_date") %>% 
  select(7:70)

## Exotic community matrix variables
exotic_community_matrix_variables <- exotic_community_matrix %>% 
  rownames_to_column(var = "replicate_date") %>% 
  select(replicate_date) %>% 
  inner_join(np_community_matrix_variables)

exotic_nmds <- metaMDS(exotic_community_matrix)
#stressplot(exotic_nmds)
#Generally, an average stress of > 0.2 is an indication that the ordination didn’t do a good job of representing community structure. However, NMDS stress increases as sample size increases, so if you have many samples (as this dataset does) your ordination will likely exhibit a lot of stress
#stress = .00015

exotic_nmds_scores <- scores(np_nmds, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("replicate_date") %>% 
  full_join(exotic_community_matrix_variables) %>% 
  drop_na(Plot)

exotic_nmds_fit <- envfit(exotic_nmds, exotic_community_matrix, perm = 999) #envfit() takes the output of metaMDS() and the species matrix you created

exotic_nmds_fit_pvals <- exotic_nmds_fit$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".") #extract p-values for each species

exotic_nmds_fit_coords <- exotic_nmds_fit %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., exotic_nmds_fit_pvals, by = "species") %>% 
  filter(pvals == 0.001) #extract coordinates for species, only keep species with p-val = 0.001


### NMDS for exotics, by plot, with species biplot
exotic_nmds_plot_species_biplot <- ggplot(exotic_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = Plot)) +
  stat_ellipse(aes(color = Plot)) +
  geom_segment(data = exotic_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = exotic_nmds_fit_coords, aes(label = species), alpha = .75) +
  theme_classic() +
  labs(title = "NMDS of exotic community, by plot", caption = "PH1 has different community (post-hoc pairwise perMANOVA p = 0.021) \n WT1 also has slightly different community (post-hoc pairwise perMANOVA p = 0.021) \ MS also has slightly different community (post-hoc pairwise perMANOVA p - .021)")
exotic_nmds_plot_species_biplot

### perMANOVA, by plot
exotic_plot_permanova <- adonis(exotic_community_matrix ~ Plot, data = exotic_community_matrix_variables)
#p = .001
###Post-hoc test
exotic_plot_pairwise <- pairwise.adonis(exotic_community_matrix, exotic_community_matrix_variables$Plot)
#PH1-WT1 p = .021, PH1-WT2 p = .063, PH1-CS p = .021, PH1-RT p = .021, PH1-TP p = .084, PH1-MS p = .021, WT1-CS p = .042, WT1-RT p = .021, WT1-MS p = .021, WT1-CS p = .021, WT1-RT p = .021, WT2-MS p = .021, CS-RT p = .021, CS-MS p = .021, RT-MS p = .021, MS-TP p = .021



### NMDS for exotics, by zone, with species biplot
exotic_nmds_zone_species_biplot <- ggplot(exotic_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = Replicate_Zone)) +
  stat_ellipse(aes(color = Replicate_Zone)) +
  geom_segment(data = exotic_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = exotic_nmds_fit_coords, aes(label = species), alpha = .75) +
  theme_classic() +
  labs(title = "NMDS of exotic community, by zone", caption = "Sig difference between center and transition zones (post-hoc pairwise perMANOVA p = 0.003) \n Sig difference between center and upland zones (post-hoc pairwise perMANOVA p = 0.003) \n Sig difference between transition and upland zones (post-hoc pairwise perMANOVA p = 0.001)")
exotic_nmds_zone_species_biplot

### perMANOVA, by zone
exotic_zone_permanova <- adonis(exotic_community_matrix ~ Replicate_Zone, data = exotic_community_matrix_variables)
#p = .001
###Post-hoc test
exotic_zone_pairwise <- pairwise.adonis(exotic_community_matrix, exotic_community_matrix_variables$Replicate_Zone)
#C-T p = .001, C-U p = .001, T-U p = .001




### NMDS for exotics, by age, with species biplot
exotic_nmds_age_species_biplot <- ggplot(exotic_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = as.factor(age))) +
  stat_ellipse(aes(color = as.factor(age))) +
  geom_segment(data = exotic_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = exotic_nmds_fit_coords, aes(label = species), alpha = .75) +
  theme_classic() +
  labs(title = "NMDS of exotic community, by pool age", caption = "Sig difference in exotic community across age (perMANOVA p = 0.001) -- community changes at year 4")
exotic_nmds_age_species_biplot

### perMANOVA, by age
exotic_age_permanova <- adonis(exotic_community_matrix ~ age, data = exotic_community_matrix_variables)
#p = .001
###Post-hoc test
exotic_age_pairwise <- pairwise.adonis(exotic_community_matrix, exotic_community_matrix_variables$age)
#6-2 p = .028, 6-3 p = .056, 2-3 p = .028, 2-4 p = .028, 2-5 p = .028, 2-7 p = .028, 2-8 p = .028, 2-9 p = .028, 3-5 p = .028, 3-8 p = .028, 3-9 p = .028, 4-7 p = .028, 5-8 p = .028



### NMDS for exotics, by month, with species biplot
exotic_nmds_month_species_biplot <- ggplot(exotic_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = month)) +
  stat_ellipse(aes(color = month)) +
  geom_segment(data = exotic_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = exotic_nmds_fit_coords, aes(label = species), alpha = .75) +
  theme_classic() +
  labs(title = "NMDS of exotic community, by monitoring month", caption = "Slight sig differences in exotic community between months")
#exotic_nmds_month_species_biplot

### perMANOVA, by month
exotic_month_permanova <- adonis(exotic_community_matrix ~ month, data = exotic_community_matrix_variables)
#p = .001
###Post-hoc test
exotic_month_pairwise <- pairwise.adonis(exotic_community_matrix, exotic_community_matrix_variables$month)
#p = .055 for some Dec, Jan, Feb, March, April, May, 



### NMDS for exotics, by year, with species biplot
exotic_nmds_year_species_biplot <- ggplot(exotic_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = as.factor(Year))) +
  stat_ellipse(aes(color = as.factor(Year))) +
  geom_segment(data = exotic_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = exotic_nmds_fit_coords, aes(label = species), alpha = .75) +
  theme_classic() +
  labs(title = "NMDS of exotic community, by montoring year", caption = "Sig difference in exotic community between years (perMANOVA p = 0.001)")
exotic_nmds_year_species_biplot

### perMANOVA, by month
exotic_year_permanova <- adonis(exotic_community_matrix ~ Year, data = exotic_community_matrix_variables)
#p = .001
###Post-hoc test
exotic_year_pairwise <- pairwise.adonis(exotic_community_matrix, exotic_community_matrix_variables$Year)
#all p = .006, except for 2016-2018 p = .024


### Partition-based cluster analysis
exotic_kmeans <- kmeans(exotic_nmds_scores[2:3], 3)

exotic_clusters <- data.frame(exotic_nmds_scores, cluster_no = factor(exotic_kmeans$cluster))

exotic_clusters <- ggplot(exotic_clusters) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = cluster_no, pch = Replicate_Zone))
exotic_clusters

```


## 1e. Is the whole community changing?

Hypothesis: If restoration was successful, then the community should be in stable equilibrium.

Results: Sig difference in community across age (perMANOVA p = 0.001) -- community changes at year 6

```{r echo = FALSE, message = FALSE, warning = FALSE}

# 1e. Is the whole community changing?

## Community matrix
np_community_matrix <- np_percent_cover %>% 
  filter(Replicate_Zone != "NA") %>% 
  mutate(Replicate_Zone = case_when(Replicate_Zone == "C" ~ "1", Replicate_Zone == "T" ~ "2", Replicate_Zone == "U" ~ "3")) %>% 
  mutate(Plot = case_when(Plot == "PH1" ~ "1", Plot == "TP" ~ "7", Plot == "RT" ~ "4", Plot == "MS" ~ "9", Plot == "WT1" ~ "14", Plot == "WT2" ~ "16", Plot == "CS" ~"19")) %>% 
  group_by(date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(mean_pc = mean(percent_cover)) %>% 
  mutate(replicate_date = paste(Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  pivot_wider(names_from = Species, values_from = mean_pc) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  column_to_rownames("replicate_date") %>% 
  select(7:141)

np_nmds <- metaMDS(np_community_matrix, trymax = 100, maxit = 999)
#stressplot(np_nmds)
#Generally, an average stress of > 0.2 is an indication that the ordination didn’t do a good job of representing community structure. However, NMDS stress increases as sample size increases, so if you have many samples (as this dataset does) your ordination will likely exhibit a lot of stress
#stress = .1843

np_nmds_scores <- scores(np_nmds, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("replicate_date") %>% 
  full_join(np_community_matrix_variables)

np_nmds_fit <- envfit(np_nmds, np_community_matrix, perm = 999) #envfit() takes the output of metaMDS() and the species matrix you created

np_nmds_fit_pvals <- np_nmds_fit$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".") #extract p-values for each species

np_nmds_fit_coords <- np_nmds_fit %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., np_nmds_fit_pvals, by = "species") %>% 
  filter(pvals == 0.001) #extract coordinates for species, only keep species with p-val = 0.001



### NMDS, by plot, with species biplot
np_nmds_plot_species_biplot <- ggplot(np_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = Plot)) +
  stat_ellipse(aes(color = Plot)) +
  geom_segment(data = np_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = np_nmds_fit_coords, aes(label = species)) +
  theme_classic() +
  labs(title = "NMDS, by plot", caption = "PH1 has different community (post-hoc pairwise perMANOVA p = 0.021) \n RT also has slightly different community (post-hoc pairwise perMANOVA p = 0.021)")
np_nmds_plot_species_biplot

### perMANOVA, by plot
np_plot_permanova <- adonis(np_community_matrix ~ Plot, data = np_community_matrix_variables)
#p = .001
###Post-hoc test
np_plot_pairwise <- pairwise.adonis(np_community_matrix, np_community_matrix_variables$Plot)
#PH1-RT p = .021, PH1-TP p = .021, PH1-MS p = .021, PH1-WT1 p = .021, PH1-WT2 p = .021, PH1-CS p = .021, RT-MS p = .021, RT-WT2 p = .021, RT-CS p = .021, TP-WT2 p = .063



### NMDS, by zone, with species biplot
np_nmds_zone_species_biplot <- ggplot(np_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = Replicate_Zone)) +
  stat_ellipse(aes(color = Replicate_Zone)) +
  geom_segment(data = np_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = np_nmds_fit_coords, aes(label = species)) +
  theme_classic() +
  labs(title = "NMDS, by zone", caption = "Central zone is sig different from  transition and upland zones (perMANOVA p = 0.067)")
np_nmds_zone_species_biplot

### perMANOVA, by zone
np_zone_permanova <- adonis(np_community_matrix ~ Replicate_Zone, data = np_community_matrix_variables)
#p = .067
###Post-hoc test
np_zone_pairwise <- pairwise.adonis(np_community_matrix, np_community_matrix_variables$Replicate_Zone)
#C-T p = .041, C-U p = .037



### NMDS, by age, with species biplot
np_nmds_age_species_biplot <- ggplot(np_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = as.factor(age))) +
  stat_ellipse(aes(color = as.factor(age))) +
  geom_segment(data = np_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = np_nmds_fit_coords, aes(label = species), alpha = .75) +
  theme_classic() +
  labs(title = "NMDS, by pool age", caption = "Sig difference in community across age (perMANOVA p = 0.001) -- community changes at year 6")
np_nmds_age_species_biplot

### perMANOVA, by age
np_age_permanova <- adonis(np_community_matrix ~ age, data = np_community_matrix_variables)
#p = .001
###Post-hoc test
np_age_pairwise <- pairwise.adonis(np_community_matrix, np_community_matrix_variables$age)
#7-6 p = .028, 2-6 p = .028, 7-5 p = .028, 7-4 p = .056, 7-3 p = .028, 7-2 p = .028, 8-6 p = .028, 8-5 p = .028, 8-4 p = .028, 8-3 p = .028, 8-2 p = .028, 9-2 p = .028, 9-3 p = .028, 9-4 p = .056, 9-5 p = .028, 9-6 p = .028



### NMDS, by month, with species biplot
np_nmds_month_species_biplot <- ggplot(np_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = month)) +
  stat_ellipse(aes(color = month)) +
  geom_segment(data = np_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = np_nmds_fit_coords, aes(label = species), alpha = .75) +
  theme_classic() +
  labs(title = "NMDS, by monitoring month", caption = "No sig difference in community across monitoring months (perMANOVA p = 0.878))")
#np_nmds_month_species_biplot

### perMANOVA, by month
np_month_permanova <- adonis(np_community_matrix ~ month, data = np_community_matrix_variables)
#p = .879




### NMDS, by year, with species biplot
np_nmds_year_species_biplot <- ggplot(np_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = as.factor(Year))) +
  stat_ellipse(aes(color = as.factor(Year))) +
  geom_segment(data = np_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = np_nmds_fit_coords, aes(label = species), alpha = .75) +
  theme_classic() +
  labs(title = "NMDS, by montoring year", caption = "Slightly sig ifference in community between years (perMANOVA p = 0.105), driven by \n difference between 2017-2019 (post-hoc pairwise perMANOVA p = 0.004) \n and difference between 2018-2019 (post-hoc pairwise perMANOVA p = 0.013) \n and difference between 2016-2017 (post-hoc pairwise perMANOVA p = 0.087)")
#np_nmds_year_species_biplot

### perMANOVA, by year
np_year_permanova <- adonis(np_community_matrix ~ Year, data = np_community_matrix_variables)
#p = .105
###Post-hoc test
np_year_pairwise <- pairwise.adonis(np_community_matrix, np_community_matrix_variables$Year)
#2017-2019 p = .004, 2018-2019 p = .013, 2016-2017 p = .087


### Partition-based cluster analysis
np_kmeans <- kmeans(np_nmds_scores[2:3], 3)

np_clusters <- data.frame(np_nmds_scores, cluster_no = factor(np_kmeans$cluster))

np_clusters <- ggplot(np_clusters) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = cluster_no, pch = Replicate_Zone)) +
  labs(title = "Partition-based cluster analysis, by zone")
np_clusters

```

## 1f. Is the native community changing?

Hypothesis: If restoration methods are the same, pools will converge on the same native community.

Results: Total native percent cover stable after sig increase after year 2 (ANOVA F(7) = 5.65, p << 0.001), but Shannon's Index of native community sig decreased after year 7 (ANOVA F(7) = 2.051, p = 0.0474)

```{r echo = FALSE, message = FALSE, warning = FALSE}

# 1f. Is the native community changing? (NMDS, cover, H')

## NMDS
### Native community matrix
native_community_matrix <- np_percent_cover %>% 
  filter(Replicate_Zone != "NA") %>% 
  filter(Native_Status == "N") %>% 
  mutate(Replicate_Zone = case_when(Replicate_Zone == "C" ~ "1", Replicate_Zone == "T" ~ "2", Replicate_Zone == "U" ~ "3")) %>% 
  mutate(Plot = case_when(Plot == "PH1" ~ "1", Plot == "TP" ~ "7", Plot == "RT" ~ "4", Plot == "MS" ~ "9", Plot == "WT1" ~ "14", Plot == "WT2" ~ "16", Plot == "CS" ~"19")) %>% 
  group_by(date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(mean_pc = mean(percent_cover)) %>% 
  mutate(replicate_date = paste(Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  drop_na(Replicate_Zone) %>% 
  pivot_wider(names_from = Species, values_from = mean_pc) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  column_to_rownames("replicate_date") %>% 
  select(7:68)

### Native community matrix variables
native_community_matrix_variables <- native_community_matrix %>% 
  rownames_to_column(var = "replicate_date") %>% 
  select(replicate_date) %>% 
  inner_join(np_community_matrix_variables)

native_nmds <- metaMDS(native_community_matrix, k = 3, trymax = 250, maxit = 9000)
#stressplot(native_nmds)
#Generally, an average stress of > 0.2 is an indication that the ordination didn’t do a good job of representing community structure. However, NMDS stress increases as sample size increases, so if you have many samples (as this dataset does) your ordination will likely exhibit a lot of stress
#stress = .1197

native_nmds_scores <- scores(native_nmds, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("replicate_date") %>% 
  full_join(native_community_matrix_variables)

native_nmds_fit <- envfit(native_nmds, native_community_matrix, perm = 999) #envfit() takes the output of metaMDS() and the species matrix you created

native_nmds_fit_pvals <- native_nmds_fit$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".") #extract p-values for each species

native_nmds_fit_coords <- native_nmds_fit %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., native_nmds_fit_pvals, by = "species") %>% 
  filter(pvals == 0.001) #extract coordinates for species, only keep species with p-val = 0.001



### NMDS, by plot, with species biplot
native_nmds_plot_species_biplot <- ggplot(np_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = Plot)) +
  stat_ellipse(aes(color = Plot)) +
  geom_segment(data = np_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = np_nmds_fit_coords, aes(label = species)) +
  theme_classic() +
  labs(title = "NMDS of native community, by plot", caption = "All native communities sig different (perMANOVA p = 0.001)")
native_nmds_plot_species_biplot

### perMANOVA, by plot
native_plot_permanova <- adonis(native_community_matrix ~ Plot, data = native_community_matrix_variables)
#p = .001
###Post-hoc test
native_plot_pairwise <- pairwise.adonis(native_community_matrix, native_community_matrix_variables$Plot)
#all p = .021



### NMDS, by zone, with species biplot
native_nmds_zone_species_biplot <- ggplot(native_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = Replicate_Zone)) +
  stat_ellipse(aes(color = Replicate_Zone)) +
  geom_segment(data = native_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = native_nmds_fit_coords, aes(label = species)) +
  theme_classic() +
  labs(title = "NMDS of native community, by zone", caption = "Central zone is sig different from  transition and upland zones (perMANOVA p = 0.001)")
native_nmds_zone_species_biplot

### perMANOVA, by zone
native_zone_permanova <- adonis(native_community_matrix ~ Replicate_Zone, data = native_community_matrix_variables)
#p = .001
###Post-hoc test
native_zone_pairwise <- pairwise.adonis(native_community_matrix, native_community_matrix_variables$Replicate_Zone)
#all p = .001



### NMDS, by age, with species biplot
native_nmds_age_species_biplot <- ggplot(native_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = as.factor(age))) +
  stat_ellipse(aes(color = as.factor(age))) +
  geom_segment(data = native_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = native_nmds_fit_coords, aes(label = species), alpha = .75) +
  theme_classic() +
  labs(title = "NMDS of native community, by pool age", caption = "Sig difference in community across age (perMANOVA p = 0.001) -- community changes after years 4, 5, 6")
native_nmds_age_species_biplot

### perMANOVA, by age
native_age_permanova <- adonis(native_community_matrix ~ age, data = native_community_matrix_variables)
#p = .001
###Post-hoc test
native_age_pairwise <- pairwise.adonis(native_community_matrix, native_community_matrix_variables$age)
#6-2 p = .056, 6-3 p = .056, 6-4 p = .028, 6-5 p = .028, 6-7 p = .028, 6-8 p = .028, 6-9 p = .056, 2-4 p = .028, 2-5 p = .028, 2-7 p = .028, 2-8 p = .028, 3-8 p = .028, 4-7 p = .028, 5-7 p = .028, 4-5 p = .084, 4-8 p = .028



### NMDS, by month, with species biplot
native_nmds_month_species_biplot <- ggplot(native_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = month)) +
  stat_ellipse(aes(color = month)) +
  geom_segment(data = native_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = native_nmds_fit_coords, aes(label = species), alpha = .75) +
  theme_classic() +
  labs(title = "NMDS of native community, by monitoring month", caption = "No sig difference in community across monitoring months (perMANOVA p = 0.813))")
#native_nmds_month_species_biplot

### perMANOVA, by month
native_month_permanova <- adonis(native_community_matrix ~ month, data = native_community_matrix_variables)
#p = .813




### NMDS, by year, with species biplot
native_nmds_year_species_biplot <- ggplot(native_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = as.factor(Year))) +
  stat_ellipse(aes(color = as.factor(Year))) +
  geom_segment(data = native_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = native_nmds_fit_coords, aes(label = species), alpha = .75) +
  theme_classic() +
  labs(title = "NMDS of native community, by montoring year", caption = "Slightly sig ifference in community between years (perMANOVA p = 0.021), driven by \n difference between 2017-2018 (post-hoc pairwise perMANOVA p = 0.348) \n and difference between 2017-2018 (post-hoc pairwise perMANOVA p = 0.264)")
#native_nmds_year_species_biplot

### perMANOVA, by year
native_year_permanova <- adonis(native_community_matrix ~ Year, data = native_community_matrix_variables)
#p = .021
###Post-hoc test
native_year_pairwise <- pairwise.adonis(native_community_matrix, native_community_matrix_variables$Year)
#2017-2018 p = .348, 2017-2019 p = .264


### Partition-based cluster analysis
native_kmeans <- kmeans(native_nmds_scores[2:3], 3)

native_clusters <- data.frame(native_nmds_scores, cluster_no = factor(native_kmeans$cluster))

native_clusters <- ggplot(native_clusters) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = cluster_no, pch = Replicate_Zone)) +
  labs(title = "Partition-based cluster analysis, by zone")
native_clusters








## Total native percent cover
### Calculate total native % cover per quadrat, find max total native % cover per quadrat per year, add time since restoration column
np_annual_total_native <- np_percent_cover %>%
  filter(Native_Status == "N") %>% 
  filter(Year > 2016) %>% 
  group_by(date, Year, Month, Plot, Replicate, Replicate_Zone) %>% 
  summarize(total_native_pc = sum(percent_cover)) %>% 
  drop_na() %>% 
  group_by(Year, Plot, Replicate, Replicate_Zone) %>% 
  summarize(max_annual_native_pc = max(total_native_pc)) %>% 
  full_join(creation_year_df) %>% 
  mutate(Creation_Year = as.numeric(as.character(Creation_Year))) %>% 
  mutate(Time_Since = Year - Creation_Year)

### Dataframe of mean & se of the max annual total % cover of each pool
np_annual_total_native_df <- np_annual_total_native %>% 
  group_by(Year, Plot, Replicate_Zone, Time_Since) %>% 
  summarize(mean = median(max_annual_native_pc),
            se = std.error(max_annual_native_pc))

### Check for normality
native_pc_hist <- ggplot(np_annual_total_native, aes(x = max_annual_native_pc)) +
  geom_histogram()
#normal
native_pc_qq <- ggplot(np_annual_total_native, aes(sample = max_annual_native_pc)) +
  geom_qq()
#normal




### Column graph of total native % cover, by time since
total_native_pc_time_col <- np_annual_total_native %>% 
  group_by(Time_Since) %>% 
  summarize(mean = mean(max_annual_native_pc),
            se = std.error(max_annual_native_pc)) %>% 
  ggplot(aes(x = as.factor(Time_Since), y = mean)) +
  geom_col(fill = "darkgreen") +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, width = .2)) +
  labs(title = "Total Percent Cover of Natives, by time since", x = "Time Since Restoration (years)", y = "Percent Cover (%)", caption = "Sig increase in mean after year 2 (ANOVA F(7) = 5.65, p << 0.001)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0)) +
  theme(text = element_text(size=20))
total_native_pc_time_col

### ANOVA of total % native cover, by time since
native_pc_time_aov <- aov(max_annual_native_pc ~ as.factor(Time_Since), data = np_annual_total_native)
#summary(native_pc_time_aov)
#p = .00544

### Tukey's Post-hoc
native_pc_time_tukey <- TukeyHSD(native_pc_time_aov)
#3-2 p = .01837, 4-2 p = .00822, 5-2 p = .0000307, 6-2 p = .0165, 7-2 p = .0454, 8-2 p = .0000313, 9-2 p = .0000313, 9-7 p = .0503




## Column graph of total native % cover, by time since, per zone
total_native_pc_time_col_zone_col <- np_annual_total_native %>% 
  group_by(Time_Since, Replicate_Zone) %>% 
  summarize(mean = mean(max_annual_native_pc),
            se = std.error(max_annual_native_pc)) %>% 
  ggplot(aes(x = as.factor(Time_Since), y = mean)) +
  geom_col(fill = "darkgreen") +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, width = .2)) +
  labs(title = "Total Percent Cover of Natives, by time since", x = "Time Since Restoration (years)", y = "Percent Cover (%)", caption = "Sig increase in mean after year 2 (ANOVA F(7) = 5.65, p << 0.001)") +
  facet_wrap(~Replicate_Zone) +
  theme_classic() +
  scale_y_continuous(expand = c(0,0)) +
  theme(text = element_text(size=20))
total_native_pc_time_col_zone_col




### Column graph of total native % cover, by monitoring year
total_native_pc_year_col <- np_annual_total_native %>% 
  group_by(Year) %>% 
  summarize(mean = mean(max_annual_native_pc),
            se = std.error(max_annual_native_pc)) %>% 
  ggplot(aes(x = as.factor(Year), y = mean)) +
  geom_col(fill = "darkgreen") +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, width = .2)) +
  labs(title = "Total Percent Cover of Natives, by monitoring year", x = "Year", y = "Percent Cover (%)", caption = "No sig difference in mean over monitoring years (ANOVA F(7) = 0.254, p = 0.776)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 100)) +
  theme(text = element_text(size=20))
#total_native_pc_year_col

### ANOVA of total % native cover, by montoring year
native_pc_year_aov <- aov(max_annual_native_pc ~ as.factor(Year), data = np_annual_total_native)
#summary(native_pc_year_aov)
#p = .776

### Tukey's Post-hoc
native_pc_time_tukey <- TukeyHSD(native_pc_time_aov)





### Column graph of total native % cover, by zone
total_native_pc_zone_col <- np_annual_total_native %>% 
  group_by(Replicate_Zone) %>% 
  summarize(mean = mean(max_annual_native_pc),
            se = std.error(max_annual_native_pc)) %>% 
  ggplot(aes(x = as.factor(Replicate_Zone), y = mean)) +
  geom_col(fill = "darkgreen") +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, width = .2)) +
  labs(title = "Total Percent Cover of Natives, by zone", x = "Year", y = "Percent Cover (%)", caption = "Upland zone sig lower mean than central zone  (Tukey's Post-Hoc p = 0.00976) \n and transition zone (Tukey's Post-Hoc p = 0.00433)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 100)) +
  theme(text = element_text(size=20))
total_native_pc_zone_col

### ANOVA of total % native cover, by montoring year
native_pc_zone_aov <- aov(max_annual_native_pc ~ as.factor(Replicate_Zone), data = np_annual_total_native)
#summary(native_pc_zone_aov)
#p << .001

### Tukey's Post-hoc
native_pc_zone_tukey <- TukeyHSD(native_pc_zone_aov)
#U-C p = .009761, U-T p = .004330





## Shannon's Index for native community

### Shannon's Index for native community of each plot
native_h_df <- np_percent_cover %>% 
  filter(Replicate_Zone != "NA") %>% 
  filter(Native_Status == "N") %>% 
  mutate(Replicate_Zone = case_when(Replicate_Zone == "C" ~ "1", Replicate_Zone == "T" ~ "2", Replicate_Zone == "U" ~ "3")) %>% 
  mutate(Plot = case_when(Plot == "PH1" ~ "1", Plot == "TP" ~ "7", Plot == "RT" ~ "4", Plot == "MS" ~ "9", Plot == "WT1" ~ "14", Plot == "WT2" ~ "16", Plot == "CS" ~"19")) %>% 
  group_by(date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(mean_pc = mean(percent_cover)) %>% 
  mutate(replicate_date = paste(Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  pivot_wider(names_from = Species, values_from = mean_pc) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  column_to_rownames("replicate_date") %>% 
  select(7:68) %>% 
  diversity() %>% 
  as.data.frame() %>% 
  rownames_to_column("replicate_date") %>%
  rename("h" = ".") %>% 
  inner_join(np_community_matrix_variables)

### Exploratory graphs
native_h_hist <- native_h_df %>% 
  ggplot(aes(x = h)) +
  geom_histogram()
#normal
native_shannon_qq <- native_h_df %>% 
  ggplot(aes(sample = h)) +
  geom_qq()
#normal

### ANOVA for exotic H', by monitoring year
native_h_year_anova <- aov(h ~ as.factor(Year), data = native_h_df)
#summary(native_h_year_anova)
#p = .665




## Shannon's Index for native community, by plot
native_h_plot_col <- native_h_df %>% 
  group_by(Plot) %>% 
  summarize(mean = mean(h),
            se = std.error(h)) %>% 
  ggplot(aes(x = as.factor(Plot), y = mean)) +
  geom_col(fill = "darkgreen") +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, width = .2)) +
  labs(title = "Shannon's Index of Natives, by pool", x = "Pool", y = "Shannon's Index", caption = "Sig difference in Shannon's Index of native communities (ANOVA F(6) = 9.244, p << .001) \n Mainly driven by PH1 and WT2") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0))
#native_h_plot_col

### ANOVA for native H', by plot
native_h_plot_anova <- aov(h ~ as.factor(Plot), data = native_h_df)
#summary(native_h_plot_anova)
#p << .001

### Tukey's Post-hoc
native_h_plot_tukey <- TukeyHSD(native_h_plot_anova)
#PH1-CS p = .0142, WT2-CS p = .00203, TP-MS p = .00921, PH1-TP p = .0000007, PH1-WT1 p = .0030, TP-RT p = .00358, WT2-TP p << .001, WT2-WT1 p = .000339




### Shannon's Index for native community, by age
native_h_age_col <- native_h_df %>% 
  group_by(age, Replicate_Zone) %>% 
  summarize(mean = mean(h),
            se = std.error(h)) %>% 
  ggplot(aes(x = as.factor(age), y = mean)) +
  geom_col(fill = "darkgreen") +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, width = .2)) +
  facet_wrap(~Replicate_Zone) +
  labs(title = "Shannon's Index of Natives, by time since restoration", x = "Time Since Restoration (years)", y = "Shannon's Index", caption = "Sig decrease in Shannon's Index of native community at year 8 (ANOVA F(7) = 2.051, p = 0.0474)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0))
native_h_age_col

### ANOVA for native H', by age
native_h_age_anova <- aov(h ~ as.factor(age), data = native_h_df)
#summary(native_h_age_anova)
#p = .0474

### Tukey's Post-hoc
native_h_age_tukey <- TukeyHSD(native_h_age_anova)
#8-4 p = .282, 8-5 p = .219, 8-6 p = .136, 8-7 p = .142





### Shannon's Index for native community, by month
native_h_month_col <- native_h_df %>% 
  group_by(month) %>% 
  summarize(mean = mean(h),
            se = std.error(h)) %>% 
  ggplot(aes(x = as.factor(month), y = mean)) +
  geom_col(fill = "darkgreen") +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, width = .2)) +
  labs(title = "Shannon's Index of Natives, by monitoring month", x = "Month", y = "Shannon's Index", caption = "No sig difference between months (ANOVA F(11) = 1.258, p = 0.246)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0))
#native_h_month_col

### ANOVA for exotic H', by month
native_h_month_anova <- aov(h ~ as.factor(month), data = native_h_df)
#summary(native_h_month_anova)
#p = .246




### Shannon's Index for native community, by zone
native_h_zone_col <- native_h_df %>% 
  group_by(Replicate_Zone) %>% 
  summarize(mean = mean(h),
            se = std.error(h)) %>% 
  ggplot(aes(x = as.factor(Replicate_Zone), y = mean)) +
  geom_col(fill = "darkgreen") +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, width = .2)) +
  labs(title = "Shannon's Index of Natives, by zone", x = "Zone", y = "Shannon's Index", caption = "Sig difference between zones (ANOVA F(2) = 244.4, p << 0.001)") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0))
native_h_zone_col

### ANOVA for native H', by zone
native_h_zone_anova <- aov(h ~ as.factor(Replicate_Zone), data = native_h_df)
#summary(native_h_zone_anova)
#p << .001

### Tukey's Post-hoc
native_h_zone_tukey <- TukeyHSD(native_h_zone_anova)
#all p << .001




```


## 1g. How does this actively managed site compare to passive management?

Hypothesis: Actively managed site will change the community.

Results: North Parcel sig different from Del Sol communities (both overall and just exotics)

```{r echo = FALSE, message = FALSE, warning = FALSE}

# 1g. How does this actively managed site compare to passive management? (NMDS w/ Del Sol data)

## Community matrix with Del Sol 2016 data
ds_np_community_matrix <- del_sol %>% 
  select(Year, Plot, Quadrat, Species, Native_Status, cover) %>% 
  mutate("Replicate_Zone" = as.character(Quadrat)) %>% 
  select(-Quadrat) %>% 
  rename("percent_cover" = "cover") %>% 
  add_column(site = "del_sol") %>% 
  add_column(date = NA) %>% 
  full_join(np_percent_cover) %>% 
  filter(Replicate_Zone != "NA") %>% 
  group_by(site, date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(mean_pc = mean(percent_cover)) %>% 
  mutate(replicate_date = paste(Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  pivot_wider(names_from = Species, values_from = mean_pc) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  column_to_rownames("replicate_date") %>% 
  select(8:149)

### Community matrix variables with Del Sol 2016 data
ds_np_community_matrix_variables <- del_sol %>% 
  select(Year, Plot, Quadrat, Species, Native_Status, cover) %>% 
  mutate("Replicate_Zone" = as.character(Quadrat)) %>% 
  select(-Quadrat) %>% 
  rename("percent_cover" = "cover") %>% 
  add_column(site = "del_sol") %>% 
  add_column(date = NA) %>% 
  full_join(np_percent_cover) %>% 
  filter(Replicate_Zone != "NA") %>% 
  group_by(site, date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(mean_pc = mean(percent_cover)) %>% 
  mutate(replicate_date = paste(Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  pivot_wider(names_from = Species, values_from = mean_pc) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  select(1:8)
ds_np_community_matrix_variables$site[is.na(ds_np_community_matrix_variables$site)] <- "north_parcel"

ds_np_nmds <- metaMDS(ds_np_community_matrix, k = 3, trymax = 250, maxit = 9000)
#stressplot(exotic_ds_np_nmds)
#Generally, an average stress of > 0.2 is an indication that the ordination didn’t do a good job of representing community structure. However, NMDS stress increases as sample size increases, so if you have many samples (as this dataset does) your ordination will likely exhibit a lot of stress
#stress = .1401

ds_np_nmds_scores <- scores(ds_np_nmds, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("replicate_date") %>% 
  full_join(ds_np_community_matrix_variables)

ds_np_nmds_fit <- envfit(ds_np_nmds, ds_np_community_matrix, perm = 999) #envfit() takes the output of metaMDS() and the species matrix you created

ds_np_nmds_fit_pvals <- ds_np_nmds_fit$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".") #extract p-values for each species

ds_np_nmds_fit_coords <- ds_np_nmds_fit %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., ds_np_nmds_fit_pvals, by = "species") %>% 
  filter(pvals == 0.001) #extract coordinates for species, only keep species with p-val = 0.001



### NMDS, by site, with species biplot
ds_np_nmds_plot_species_biplot <- ggplot(ds_np_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = Plot)) +
  stat_ellipse(aes(color = site)) +
  geom_segment(data = ds_np_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = ds_np_nmds_fit_coords, aes(label = species)) +
  theme_classic() +
  labs(title = "NMDS, by site", caption = "Del Sol communities sig different from North Parcel communities (perMANOVA p = 0.001)")
ds_np_nmds_plot_species_biplot

### perMANOVA, by site
ds_np_site_permanova <- adonis(ds_np_community_matrix ~ site, data = ds_np_community_matrix_variables)
#p = .001
###Post-hoc test
ds_np_site_pairwise <- pairwise.adonis(ds_np_community_matrix, ds_np_community_matrix_variables$site)
#p = .1117

### Partition-based cluster analysis
ds_np_kmeans <- kmeans(ds_np_nmds_scores[2:3], 2)

ds_np_clusters <- data.frame(ds_np_nmds_scores, cluster_no = factor(ds_np_kmeans$cluster))

ds_np_clusters <- ggplot(ds_np_clusters) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = cluster_no, pch = site)) +
  labs(title = "Partition-based cluster analysis, by site")
ds_np_clusters





## Exotic community matrix with Del Sol 2016 data
exotic_ds_np_community_matrix <- del_sol %>% 
  select(Year, Plot, Quadrat, Species, Native, cover) %>% 
  mutate("Replicate_Zone" = as.character(Quadrat)) %>% 
  select(-Quadrat) %>% 
  rename("percent_cover" = "cover") %>% 
  rename("Native_Status" = "Native") %>% 
  add_column(site = "del_sol") %>% 
  add_column(date = NA) %>% 
  full_join(np_percent_cover) %>% 
  filter(Replicate_Zone != "NA") %>% 
  filter(Native_Status == "E") %>% 
  group_by(site, date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(mean_pc = mean(percent_cover)) %>% 
  mutate(replicate_date = paste(Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  pivot_wider(names_from = Species, values_from = mean_pc) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  column_to_rownames("replicate_date") %>% 
  select(8:78)

### Exotic community matrix variables with Del Sol 2016 data
exotic_ds_np_community_matrix_variables <- del_sol %>% 
  select(Year, Plot, Quadrat, Species, Native, cover) %>% 
  mutate("Replicate_Zone" = as.character(Quadrat)) %>% 
  select(-Quadrat) %>% 
  rename("percent_cover" = "cover") %>% 
  rename("Native_Status" = "Native") %>% 
  add_column(site = "del_sol") %>% 
  add_column(date = NA) %>% 
  full_join(np_percent_cover) %>% 
  filter(Replicate_Zone != "NA") %>% 
  filter(Native_Status == "E") %>% 
  group_by(site, date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(mean_pc = mean(percent_cover)) %>% 
  mutate(replicate_date = paste(Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  pivot_wider(names_from = Species, values_from = mean_pc) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  select(1:8)
exotic_ds_np_community_matrix_variables$site[is.na(exotic_ds_np_community_matrix_variables$site)] <- "north_parcel"

exotic_ds_np_nmds <- metaMDS(exotic_ds_np_community_matrix, trymax = 100, maxit = 999)
#stressplot(exotic_ds_np_nmds)
#Generally, an average stress of > 0.2 is an indication that the ordination didn’t do a good job of representing community structure. However, NMDS stress increases as sample size increases, so if you have many samples (as this dataset does) your ordination will likely exhibit a lot of stress
#stress = .0002325

exotic_ds_np_nmds_scores <- scores(exotic_ds_np_nmds, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("replicate_date") %>% 
  full_join(exotic_ds_np_community_matrix_variables)

exotic_ds_np_nmds_fit <- envfit(exotic_ds_np_nmds, exotic_ds_np_community_matrix, perm = 999) #envfit() takes the output of metaMDS() and the species matrix you created

exotic_ds_np_nmds_fit_pvals <- exotic_ds_np_nmds_fit$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".") #extract p-values for each species

exotic_ds_np_nmds_fit_coords <- exotic_ds_np_nmds_fit %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., exotic_ds_np_nmds_fit_pvals, by = "species") %>% 
  filter(pvals == 0.001) #extract coordinates for species, only keep species with p-val = 0.001



### NMDS for exotic community, by site, with species biplot
exotic_ds_np_nmds_site_species_biplot <- ggplot(exotic_ds_np_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = Plot)) +
  stat_ellipse(aes(color = site)) +
  geom_segment(data = exotic_ds_np_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = exotic_ds_np_nmds_fit_coords, aes(label = species)) +
  theme_classic() +
  labs(title = "NMDS, by site", caption = "Exotic Del Sol communities sig different from exotic North Parcel communities (perMANOVA p = 0.001)") +
  scale_y_continuous(expand = c(0,0), limits = c(-20, 20)) +
  scale_x_continuous(expand = c(0,0), limits = c(-20, 20))
#exotic_ds_np_nmds_site_species_biplot

### perMANOVA, by site
exotic_ds_np_site_permanova <- adonis(exotic_ds_np_community_matrix ~ site, data = exotic_ds_np_community_matrix_variables)
#p = .001
###Post-hoc test
exotic_ds_np_site_pairwise <- pairwise.adonis(exotic_ds_np_community_matrix, exotic_ds_np_community_matrix_variables$site)
#p = .0788


```


# 2. What environmental filters can be manipulated to decrease exotics?
## 2a. How does the seedbank compare to the aboveground cover?
H1: If exotic species are coming up in above-ground monitoring that are not found in below-ground seedbank diversity, then seeds are blowing in from surrounding invaded matrix.
H2: If native species are in the seedbank but are not found in above-ground monitoring, then an environmental filter is preventing them from germinating, despite sustained weeding effort.

Results: Exotic seedbank communities sig different from exotic above-ground communities (perMANOVA p = 0.001)

```{r echo = FALSE, message = FALSE, warning = FALSE}

# 2a. How does the seedbank compare to the aboveground cover? (NMDS w/ presence/absence data)


## Exotic community matrix with seedbank data
np_seedbank_community_matrix <- seedbank_2016 %>% 
  full_join(np_seedbank_2018) %>% 
  drop_na(Plot) %>% 
  select(seedbank, Year, Plot, Replicate, Replicate_Zone, Species, Native_Status, Count) %>% 
  rename("percent_cover" = "Count") %>% 
  add_column(date = NA) %>% 
  full_join(np_percent_cover) %>% 
  filter(Native_Status == "E") %>% 
  filter(Replicate_Zone != "NA") %>% 
  group_by(seedbank, date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(sum = sum(percent_cover)) %>% 
  mutate(replicate_date = paste(seedbank, Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  mutate(sum = case_when(sum >0 ~ 1)) %>% 
  pivot_wider(names_from = Species, values_from = sum) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  column_to_rownames("replicate_date") %>% 
  select(8:80)

### Exotic community matrix variables with seedbank data
np_seedbank_community_matrix_variables <- seedbank_2016 %>% 
  full_join(np_seedbank_2018) %>% 
  drop_na(Plot) %>% 
  select(seedbank, Year, Plot, Replicate, Replicate_Zone, Species, Native_Status, Count) %>% 
  rename("percent_cover" = "Count") %>% 
  add_column(date = NA) %>% 
  full_join(np_percent_cover) %>% 
  filter(Native_Status == "E") %>% 
  filter(Replicate_Zone != "NA") %>% 
  group_by(seedbank, date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(sum = sum(percent_cover)) %>% 
  mutate(replicate_date = paste(seedbank, Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  mutate(sum = case_when(sum >0 ~ 1)) %>% 
  pivot_wider(names_from = Species, values_from = sum) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  select(1:8)
np_seedbank_community_matrix_variables$seedbank[is.na(np_seedbank_community_matrix_variables$seedbank)] <- "above_ground"

## NMDS
np_seedbank_nmds <- metaMDS(np_seedbank_community_matrix, trymax = 100, maxit = 999)
#stressplot(np_seedbank_nmds)
#Generally, an average stress of > 0.2 is an indication that the ordination didn’t do a good job of representing community structure. However, NMDS stress increases as sample size increases, so if you have many samples (as this dataset does) your ordination will likely exhibit a lot of stress
#stress = .0002055

np_seedbank_nmds_scores <- scores(np_seedbank_nmds, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("replicate_date") %>% 
  full_join(np_seedbank_community_matrix_variables)

np_seedbank_nmds_fit <- envfit(np_seedbank_nmds, np_seedbank_community_matrix, perm = 999) #envfit() takes the output of metaMDS() and the species matrix you created

np_seedbank_nmds_fit_pvals <- np_seedbank_nmds_fit$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".") #extract p-values for each species

np_seedbank_nmds_fit_coords <- np_seedbank_nmds_fit %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., np_seedbank_nmds_fit_pvals, by = "species") %>% 
  filter(pvals == 0.001) #extract coordinates for species, only keep species with p-val = 0.001



### NMDS, with seedbank, with species biplot
np_seedbank_nmds_species_biplot <- ggplot(np_seedbank_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = seedbank)) +
  stat_ellipse(aes(color = seedbank)) +
  geom_segment(data = np_seedbank_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = np_seedbank_nmds_fit_coords, aes(label = species)) +
  theme_classic() +
  labs(title = "NMDS of North Parcel seedbank and percent cover data", caption = "Exotic seedbank communities sig different from exotic above-ground communities (perMANOVA p = 0.001)") +
  scale_y_continuous(limits = c(-20, 20)) +
  scale_x_continuous(limits = c(-200, 200))
#np_seedbank_nmds_species_biplot

### perMANOVA, by site
np_seedbank_site_permanova <- adonis(np_seedbank_community_matrix ~ as.factor(seedbank), data = np_seedbank_community_matrix_variables)
#p = .001
###Post-hoc test
np_seedbank_site_pairwise <- pairwise.adonis(np_seedbank_community_matrix, np_seedbank_community_matrix_variables$seedbank)
#all p = .003






## Add Year column to seedbank_2016, add presence/absence column
seedbank_2016_pa <- seedbank_2016 %>%
  group_by(Year, Plot, Replicate_Zone, Species_Full_Name, Native_Status) %>% 
  summarize(
    max = max(Count)
  ) %>% 
  filter(max>0) %>% 
  add_column(present = 1)

## Add presence/absence column to 2017 percent cover data, join to 2016 seed bank
pa_2016_2017 <- np_percent_cover %>% 
  filter(Year == "2017") %>% 
  group_by(Year, Plot, Replicate_Zone, Species_Full_Name, Native_Status) %>% 
  summarize(
    max = max(percent_cover)
  ) %>% 
  add_column(present = 1) %>% 
  full_join(seedbank_2016_pa) %>% 
  na.omit()

## Plot exotics in 2016 seed bank vs. 2017, by zone, for RT
rt_exotic_pa <- pa_2016_2017 %>% 
  filter(Native_Status == "E") %>% 
  filter(Plot == "RT") %>% 
  ggplot(aes(x = Species_Full_Name, y = present)) +
  geom_col(aes(fill = as.factor(Year))) +
  facet_wrap(~Replicate_Zone) +
  scale_fill_manual(values = c("darkgreen", "chartreuse4"), label = c("2016 seed bank", "2017 monitoring"), name = "Year") +
    labs(title = "RT: Exotic Species in Seed Bank vs. Monitoring", x = "Species", y = "Presence", caption = "More exotics coming up in upland zone than are in seed bank") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))
rt_exotic_pa

# Scatter comparing 2016 vs 2017 presence/absence
exotic_pa_scatter <- pa_2016_2017 %>% 
  filter(Native_Status == "E") %>% 
  spread(Year, present) %>% 
  rename(seventeen = "2017") %>% 
  rename(sixteen = "2016") %>% 
  mutate_all(funs(ifelse(is.na(.), 0, .))) %>% 
  ggplot(aes(x = sixteen, y = seventeen)) +
  geom_jitter(aes(color = Species_Full_Name, shape = Plot)) +
  facet_wrap(~Replicate_Zone) +
  scale_fill_manual(values = c("darkgreen", "chartreuse4"), label = c("2016 seed bank", "2017 monitoring"), name = "Year") +
    labs(title = "Exotic Species in Seed Bank vs. Monitoring", x = "Species", y = "Presence", caption = "More exotics coming up in upland zone than are in seed bank") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))
ggplotly(exotic_pa_scatter)


# Plot % cover for seed bank + monitoring species
exotic_pa_cover_both <- pa_2016_2017 %>% 
  filter(Native_Status == "E") %>% 
  spread(Year, present) %>% 
  rename(seventeen = "2017") %>% 
  rename(sixteen = "2016") %>% 
  mutate_all(funs(ifelse(is.na(.), 0, .))) %>% 
  mutate(both = seventeen + sixteen) %>% 
  filter(both == 2) %>% 
  ggplot(aes(y = max, x = Species_Full_Name)) +
  geom_point(aes(color = Plot)) +
  facet_wrap(~Replicate_Zone) +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 5)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))
exotic_pa_cover_both

# Plot % cover for just monitoring species
exotic_pa_cover <- pa_2016_2017 %>% 
  filter(Native_Status == "E") %>% 
  spread(Year, present) %>% 
  rename(seventeen = "2017") %>% 
  rename(sixteen = "2016") %>% 
  mutate_all(funs(ifelse(is.na(.), 0, .))) %>% 
  mutate(both = seventeen + sixteen) %>% 
  filter(seventeen == 1) %>% 
  filter(both == 1) %>% 
  ggplot(aes(y = max, x = Species_Full_Name)) +
  geom_point(aes(color = Plot)) +
  facet_wrap(~Replicate_Zone) +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 45)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))
exotic_pa_cover

```



## 2b. Does active management result in a different exotic community?
Hypothesis: Actively managed site will change the community.

Results: North Parcel sig different from Del Sol communities (both with all seedbank data and all seedbank and percent cover data)


```{r echo = FALSE, message = FALSE, warning = FALSE}

# 2b. Does active management result in a different exotic community? (NMDS w/ old Del Sol data)

## Exotic community matrix of all seedbank data
seedbank_community_matrix <- seedbank_2016 %>% 
  full_join(np_seedbank_2018) %>% 
  full_join(del_sol_seedbank) %>% 
  drop_na(Plot) %>% 
  select(seedbank, Year, Plot, Replicate, Replicate_Zone, Species, Native_Status, Count) %>% 
  filter(Native_Status == "E") %>% 
  filter(Replicate_Zone != "NA") %>% 
  group_by(seedbank, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(mean = mean(Count)) %>% 
  mutate(replicate_date = paste(seedbank, Plot, Replicate_Zone, sep = "-")) %>% 
  pivot_wider(names_from = Species, values_from = mean) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  column_to_rownames("replicate_date") %>% 
  select(5:34)

### Exotic community matrix variables of all seedbank data
seedbank_community_matrix_variables <- seedbank_2016 %>% 
  full_join(np_seedbank_2018) %>% 
  full_join(del_sol_seedbank) %>% 
  drop_na(Plot) %>% 
  select(seedbank, Year, Plot, Replicate, Replicate_Zone, Species, Native_Status, Count) %>% 
  filter(Native_Status == "E") %>% 
  filter(Replicate_Zone != "NA") %>% 
  group_by(seedbank, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(mean = mean(Count)) %>% 
  mutate(replicate_date = paste(seedbank, Plot, Replicate_Zone, sep = "-")) %>% 
  pivot_wider(names_from = Species, values_from = mean) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  select(1:5)

## NMDS
seedbank_nmds <- metaMDS(seedbank_community_matrix, trymax = 250, maxit = 9000)
#stressplot(seedbank_nmds)
#Generally, an average stress of > 0.2 is an indication that the ordination didn’t do a good job of representing community structure. However, NMDS stress increases as sample size increases, so if you have many samples (as this dataset does) your ordination will likely exhibit a lot of stress
#stress = .17017

seedbank_nmds_scores <- scores(seedbank_nmds, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("replicate_date") %>% 
  full_join(seedbank_community_matrix_variables)

seedbank_nmds_fit <- envfit(seedbank_nmds, seedbank_community_matrix, perm = 999) #envfit() takes the output of metaMDS() and the species matrix you created

seedbank_nmds_fit_pvals <- seedbank_nmds_fit$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".") #extract p-values for each species

seedbank_nmds_fit_coords <- seedbank_nmds_fit %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., seedbank_nmds_fit_pvals, by = "species") %>% 
  filter(pvals == 0.001) #extract coordinates for species, only keep species with p-val = 0.001



### NMDS of all seedbank data, with species biplot
seedbank_nmds_species_biplot <- ggplot(seedbank_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = seedbank)) +
  stat_ellipse(aes(color = seedbank)) +
  geom_segment(data = seedbank_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = seedbank_nmds_fit_coords, aes(label = species)) +
  theme_classic() +
  labs(title = "NMDS of all seedbank data", caption = "Exotic seedbank communities sig different (perMANOVA p = 0.001)")
seedbank_nmds_species_biplot

### perMANOVA, by site
seedbank_site_permanova <- adonis(seedbank_community_matrix ~ as.factor(seedbank), data = seedbank_community_matrix_variables)
#p = .001
###Post-hoc test
seedbank_site_pairwise <- pairwise.adonis(seedbank_community_matrix, seedbank_community_matrix_variables$seedbank)
#all p = .003

### Partition-based cluster analysis
seedbank_kmeans <- kmeans(seedbank_nmds_scores[2:3], 3)

seedbank_clusters <- data.frame(seedbank_nmds_scores, cluster_no = factor(seedbank_kmeans$cluster))

seedbank_clusters <- ggplot(seedbank_clusters) +
  geom_point(aes(x = NMDS1, y = NMDS2, color = cluster_no, pch = seedbank)) +
  labs(title = "Partition-based cluster analysis, by source")
seedbank_clusters











 ## Community matrix with all Del Sol and North Parcel data
ds_np_pc <- del_sol %>% 
  select(Year, Plot, Quadrat, Species, Native_Status, cover) %>% 
  mutate("Replicate_Zone" = as.character(Quadrat)) %>% 
  select(-Quadrat) %>% 
  rename("percent_cover" = "cover") %>% 
  add_column(site = "del_sol") %>% 
  add_column(date = NA) %>% 
  full_join(np_percent_cover)
ds_np_pc$site[is.na(ds_np_pc$site)] <- "north_parcel"

all_ds_np_community_matrix <- seedbank_2016 %>% 
  full_join(np_seedbank_2018) %>% 
  full_join(del_sol_seedbank) %>% 
  drop_na(Plot) %>% 
  select(seedbank, Year, Plot, Replicate, Replicate_Zone, Species, Native_Status, Count) %>% 
  rename("percent_cover" = "Count") %>% 
  add_column(date = NA) %>% 
  full_join(ds_np_pc) %>% 
  filter(Native_Status == "E") %>% 
  filter(Replicate_Zone != "NA") %>% 
  group_by(seedbank, site, date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(sum = sum(percent_cover)) %>% 
  mutate(sum = case_when(sum >0 ~ 1)) %>% 
  mutate(replicate_date = paste(seedbank, site, Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  mutate(site_seedbank = paste(site, seedbank, sep = ".")) %>% 
  pivot_wider(names_from = Species, values_from = sum) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  column_to_rownames("replicate_date") %>% 
  select(10:89)

### Community matrix variables with all Del Sol and North Parcel data
all_ds_np_community_matrix_variables <- seedbank_2016 %>% 
  full_join(np_seedbank_2018) %>% 
  full_join(del_sol_seedbank) %>% 
  drop_na(Plot) %>% 
  select(seedbank, Year, Plot, Replicate, Replicate_Zone, Species, Native_Status, Count) %>% 
  rename("percent_cover" = "Count") %>% 
  add_column(date = NA) %>% 
  full_join(ds_np_pc) %>% 
  filter(Native_Status == "E") %>% 
  filter(Replicate_Zone != "NA") %>% 
  group_by(seedbank, site, date, month_number, Year, Plot, Replicate_Zone, Species) %>% 
  summarize(sum = sum(percent_cover)) %>% 
  mutate(sum = case_when(sum >0 ~ 1)) %>% 
  mutate(replicate_date = paste(seedbank, site, Plot, Replicate_Zone, date, sep = "-")) %>% 
  mutate(month_year = paste(Year, month_number, sep = ".")) %>% 
  mutate(site_seedbank = paste(site, seedbank, sep = ".")) %>%
  pivot_wider(names_from = Species, values_from = sum) %>% 
  mutate_all(funs(replace_na(.,0))) %>% 
  select(1:10)

## NMDS
all_ds_np_nmds <- metaMDS(all_ds_np_community_matrix)
#stressplot(all_ds_np_nmds)
#Generally, an average stress of > 0.2 is an indication that the ordination didn’t do a good job of representing community structure. However, NMDS stress increases as sample size increases, so if you have many samples (as this dataset does) your ordination will likely exhibit a lot of stress
#stress = .0002629

all_ds_np_nmds_scores <- scores(all_ds_np_nmds, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("replicate_date") %>% 
  full_join(all_ds_np_community_matrix_variables)

all_ds_np_nmds_fit <- envfit(all_ds_np_nmds, all_ds_np_community_matrix, perm = 999) #envfit() takes the output of metaMDS() and the species matrix you created

all_ds_np_nmds_fit_pvals <- all_ds_np_nmds_fit$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".") #extract p-values for each species

all_ds_np_nmds_fit_coords <- all_ds_np_nmds_fit %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., all_ds_np_nmds_fit_pvals, by = "species") %>% 
  filter(pvals == 0.001) #extract coordinates for species, only keep species with p-val = 0.001



### NMDS of all Del Sol and North Parcel data, with species biplot
all_ds_np_nmds_species_biplot <- ggplot(all_ds_np_nmds_scores, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = site_seedbank)) +
  stat_ellipse(aes(color = site_seedbank)) +
  geom_segment(data = seedbank_nmds_fit_coords, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = all_ds_np_nmds_fit_coords, aes(label = species)) +
  theme_classic() +
  labs(title = "NMDS of all Del Sol and North Parcel data", caption = "Exotic  communities sig different (perMANOVA p = 0.001)") +
  scale_y_continuous(limits = c(-20, 20)) +
  scale_x_continuous(limits = c(-200, 200))
#all_ds_np_nmds_species_biplot

### perMANOVA, by site
all_ds_np_site_permanova <- adonis(all_ds_np_community_matrix ~ as.factor(site_seedbank), data = all_ds_np_community_matrix_variables)
#p = .001
###Post-hoc test
all_ds_np_site_pairwise <- pairwise.adonis(all_ds_np_community_matrix, all_ds_np_community_matrix_variables$site_seedbank)
#all p = .01








# Plot Del Sol percent cover
del_sol_cover <- del_sol %>% 
  full_join(metadata) %>% 
  drop_na(Plot) %>% 
  group_by(Plot, Species_Full_Name, Native_Status) %>% 
  summarize(
    cover = mean(cover)
  )

del_sol_cover_scatter <- ggplot(del_sol_cover, aes(x = Species_Full_Name, y = cover)) +
  geom_point(aes(color = Plot)) +
  theme_classic() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 70)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~Native_Status)
del_sol_cover_scatter

# Plot Del Sol vs. NP 2017 percent cover, using mean of each species
del_sol_cover_col <-  np_percent_cover %>% 
  filter(Year == "2017") %>% 
  group_by(Year, Plot, Replicate_Zone, Species_Full_Name, Native_Status) %>% 
  summarize(
    cover = max(percent_cover)
  ) %>% 
  full_join(del_sol_cover) %>% 
  drop_na(Native_Status) %>% 
  ggplot(aes(x = reorder(Species_Full_Name, -cover), y = cover)) +
  geom_col(aes(fill = as.factor(Year)), position = "dodge") +
  theme_classic() +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~Native_Status)
del_sol_cover_col

```


